---
// FormDemo.astro - Formulario reutilizable para demos
export interface Props {
  formId?: string;
  whatsappUrl?: string;
  formspreeId?: string;
  showWhatsAppButton?: boolean;
  buttonText?: string;
  description?: string;
}

const { 
  formId = "demo-form",
  whatsappUrl = "https://wa.me/580000000000?text=Hola%20quiero%20la%20demo",
  formspreeId = "TU_ID_FORMSPREE",
  showWhatsAppButton = true,
  buttonText = "Solicitar demo gratuita",
  description = "Sin compromiso. Te mostramos cómo funciona antes de pagar."
} = Astro.props;
---

<div class="bg-white/5 backdrop-blur-sm rounded-xl p-6 md:p-8 max-w-md mx-auto border border-white/10">
  <form 
    id={formId} 
    class="space-y-4" 
    action={`https://formspree.io/f/${formspreeId}`}
    method="POST"
    novalidate
  >
    <!-- Nombre -->
    <div>
      <input 
        type="text" 
        id={`${formId}-name`} 
        name="name" 
        required
        class="w-full rounded-lg p-4 bg-white/20 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-[#FF8A00]/40 focus:border-[#FF8A00]/60 transition-all duration-300 text-base"
        placeholder="Tu nombre completo"
        aria-label="Nombre completo"
      />
      <div id={`${formId}-name-error`} class="text-red-200 text-sm mt-2 hidden" role="alert"></div>
    </div>

    <!-- Email -->
    <div>
      <input 
        type="email" 
        id={`${formId}-email`} 
        name="email" 
        required
        class="w-full rounded-lg p-4 bg-white/20 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-[#FF8A00]/40 focus:border-[#FF8A00]/60 transition-all duration-300 text-base"
        placeholder="tu@email.com"
        aria-label="Correo electrónico"
      />
      <div id={`${formId}-email-error`} class="text-red-200 text-sm mt-2 hidden" role="alert"></div>
    </div>

    <!-- WhatsApp -->
    <div>
      <input 
        type="tel" 
        id={`${formId}-whatsapp`} 
        name="whatsapp"
        class="w-full rounded-lg p-4 bg-white/20 text-white placeholder-white/60 border border-white/20 focus:outline-none focus:ring-2 focus:ring-[#FF8A00]/40 focus:border-[#FF8A00]/60 transition-all duration-300 text-base"
        placeholder="+56 9 1234 5678"
        aria-label="Número de WhatsApp"
      />
      <div id={`${formId}-whatsapp-error`} class="text-red-200 text-sm mt-2 hidden" role="alert"></div>
    </div>

    <!-- Campo oculto para source (UTM) -->
    <input 
      type="hidden" 
      id={`${formId}-source`} 
      name="source" 
      value=""
    />

    <!-- Honeypot para spam -->
    <input 
      type="text" 
      name="company" 
      style="display: none;" 
      tabindex="-1" 
      autocomplete="off"
    />

    <!-- Botón de envío -->
    <button 
      type="submit" 
      class="w-full py-4 rounded-lg bg-gradient-to-r from-[#C0176C] to-[#FF8A00] font-semibold text-white text-lg
             hover:opacity-95 active:scale-[0.98] focus:outline-none focus:ring-2 focus:ring-[#FF8A00]/60
             transition-all duration-300 disabled:opacity-50 disabled:cursor-not-allowed"
      data-analytics="demo-form-submit"
      aria-label={buttonText}
    >
      <span class="btn-text">{buttonText}</span>
      <span class="btn-loading hidden">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white inline" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
        </svg>
        Enviando...
      </span>
    </button>

    <!-- Texto descriptivo -->
    <p class="text-sm text-white/50 mt-4 text-center">
      {description}
    </p>

    <!-- Mensajes de estado -->
    <div id={`${formId}-messages`} class="hidden">
      <div id={`${formId}-success-message`} class="bg-green-500/10 border border-green-500/30 rounded-lg p-4 text-green-200 text-center hidden">
        <div class="flex items-center justify-center space-x-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
          </svg>
          <span class="font-medium">¡Gracias! Revisa tu WhatsApp/email en breve.</span>
        </div>
      </div>
      <div id={`${formId}-error-message`} class="bg-red-500/10 border border-red-500/30 rounded-lg p-4 text-red-200 text-center hidden">
        <div class="flex items-center justify-center space-x-2">
          <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7 4a1 1 0 11-2 0 1 1 0 012 0zm-1-9a1 1 0 00-1 1v4a1 1 0 102 0V6a1 1 0 00-1-1z" clip-rule="evenodd"></path>
          </svg>
          <span class="font-medium">Error al enviar. Inténtalo de nuevo.</span>
        </div>
      </div>
    </div>
  </form>

  <!-- Botón WhatsApp adicional -->
  {showWhatsAppButton && (
    <div class="mt-4">
      <a 
        href={whatsappUrl}
        target="_blank"
        rel="noopener noreferrer"
        class="w-full inline-flex items-center justify-center py-4 px-6 bg-green-600 hover:bg-green-700 text-white font-semibold rounded-lg transition-all duration-300 text-lg"
        data-analytics="whatsapp-contact"
        aria-label="Contactar por WhatsApp"
      >
        <svg class="mr-3 w-5 h-5" fill="currentColor" viewBox="0 0 24 24">
          <path d="M17.472 14.382c-.297-.149-1.758-.867-2.03-.967-.273-.099-.471-.148-.67.15-.197.297-.767.966-.94 1.164-.173.199-.347.223-.644.075-.297-.15-1.255-.463-2.39-1.475-.883-.788-1.48-1.761-1.653-2.059-.173-.297-.018-.458.13-.606.134-.133.298-.347.446-.52.149-.174.198-.298.298-.497.099-.198.05-.371-.025-.52-.075-.149-.669-1.612-.916-2.207-.242-.579-.487-.5-.669-.51-.173-.008-.371-.01-.57-.01-.198 0-.52.074-.792.372-.272.297-1.04 1.016-1.04 2.479 0 1.462 1.065 2.875 1.213 3.074.149.198 2.096 3.2 5.077 4.487.709.306 1.262.489 1.694.625.712.227 1.36.195 1.871.118.571-.085 1.758-.719 2.006-1.413.248-.694.248-1.289.173-1.413-.074-.124-.272-.198-.57-.347m-5.421 7.403h-.004a9.87 9.87 0 01-5.031-1.378l-.361-.214-3.741.982.998-3.648-.235-.374a9.86 9.86 0 01-1.51-5.26c.001-5.45 4.436-9.884 9.888-9.884 2.64 0 5.122 1.03 6.988 2.898a9.825 9.825 0 012.893 6.994c-.003 5.45-4.437 9.884-9.885 9.884m8.413-18.297A11.815 11.815 0 0012.05 0C5.495 0 .16 5.335.157 11.892c0 2.096.547 4.142 1.588 5.945L.057 24l6.305-1.654a11.882 11.882 0 005.683 1.448h.005c6.554 0 11.89-5.335 11.893-11.893A11.821 11.821 0 0020.885 3.488"/>
        </svg>
        Hablar por WhatsApp
      </a>
    </div>
  )}
</div>

<script>
  // Configuración del formulario
  const formId = '${formId}';
  const form = document.getElementById(formId);
  
  if (form) {
    // Rellenar campo source con UTMs
    function fillSourceField() {
      const utmData = sessionStorage.getItem('utm_data');
      if (utmData) {
        const data = JSON.parse(utmData);
        const sourceField = document.getElementById(`${formId}-source`);
        if (sourceField) {
          sourceField.value = `${data.source}-${data.campaign}`;
        }
      }
    }
    
    // Validación del formulario
    function validateForm(formData) {
      const errors = {};
      
      // Validar nombre
      if (!formData.get('name') || formData.get('name').trim().length < 2) {
        errors.name = 'El nombre debe tener al menos 2 caracteres';
      }
      
      // Validar email
      const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
      if (!formData.get('email') || !emailRegex.test(formData.get('email'))) {
        errors.email = 'Ingresa un email válido';
      }
      
      // Validar WhatsApp (opcional pero si se proporciona debe ser válido)
      const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
      if (formData.get('whatsapp') && !phoneRegex.test(formData.get('whatsapp').replace(/\s/g, ''))) {
        errors.whatsapp = 'Ingresa un número de WhatsApp válido';
      }
      
      return errors;
    }
    
    // Mostrar errores
    function showErrors(errors) {
      // Limpiar errores anteriores
      document.querySelectorAll(`[id$="-error"]`).forEach(el => {
        el.classList.add('hidden');
        el.textContent = '';
      });
      
      // Mostrar nuevos errores
      Object.keys(errors).forEach(field => {
        const errorEl = document.getElementById(`${formId}-${field}-error`);
        if (errorEl) {
          errorEl.textContent = errors[field];
          errorEl.classList.remove('hidden');
        }
      });
    }
    
    // Manejar envío del formulario
    form.addEventListener('submit', async function(e) {
      e.preventDefault();
      
      const formData = new FormData(form);
      const submitBtn = form.querySelector('button[type="submit"]');
      const btnText = submitBtn.querySelector('.btn-text');
      const btnLoading = submitBtn.querySelector('.btn-loading');
      const messages = document.getElementById(`${formId}-messages`);
      const successMsg = document.getElementById(`${formId}-success-message`);
      const errorMsg = document.getElementById(`${formId}-error-message`);
      
      // Validar formulario
      const errors = validateForm(formData);
      if (Object.keys(errors).length > 0) {
        showErrors(errors);
        return;
      }
      
      // Mostrar estado de carga
      submitBtn.disabled = true;
      btnText.classList.add('hidden');
      btnLoading.classList.remove('hidden');
      messages.classList.remove('hidden');
      successMsg.classList.add('hidden');
      errorMsg.classList.add('hidden');
      
      try {
        const response = await fetch(form.action, {
          method: 'POST',
          headers: {
            'Accept': 'application/json'
          },
          body: formData
        });
        
        if (response.ok) {
          // Éxito
          successMsg.classList.remove('hidden');
          errorMsg.classList.add('hidden');
          
          // Limpiar formulario
          form.reset();
          
          // Analytics
          if (typeof gtag !== 'undefined') {
            gtag('event', 'form_submit', {
              event_category: 'Demo_Request',
              event_label: 'success'
            });
          }
          
          // Meta Pixel Lead tracking
          if (typeof window !== 'undefined' && window.fbq) {
            window.fbq('track','Lead', { 
              source: formData.get('source') || 'direct'
            });
          }
        } else {
          // Error
          successMsg.classList.add('hidden');
          errorMsg.classList.remove('hidden');
          
          // Analytics
          if (typeof gtag !== 'undefined') {
            gtag('event', 'form_submit', {
              event_category: 'Demo_Request',
              event_label: 'error'
            });
          }
        }
      } catch (error) {
        console.error('Error:', error);
        successMsg.classList.add('hidden');
        errorMsg.classList.remove('hidden');
      } finally {
        // Restaurar botón
        submitBtn.disabled = false;
        btnText.classList.remove('hidden');
        btnLoading.classList.add('hidden');
      }
    });
    
    // Rellenar campo source al cargar
    fillSourceField();
  }
</script>
